---
- hosts: all
  vars:
    agent_version: 2.2.1
  remote_user: vagrant
  become: yes
  become_method: sudo
  tasks:
      - name: install general packages
        yum: name=wget,mc,net-tools,tmux,telnet,vim,libselinux-python,python-pip,git,unzip state=present
      - name: install java
        script: /vagrant/bootstrap/install_java.sh
        args:
            creates: /opt/java
      - name: install server agent
        script: "/vagrant/bootstrap/install_server_agent.sh {{agent_version}}"
        args:
            creates: /opt/server-agent
      - name: copy init scripts to manage agent server
        template: src={{ item.src }} dest={{ item.dest }} mode=751
        with_items:
            - { src: '/vagrant/bootstrap/agent', dest: '/etc/init.d/agent' }
      - name: start server agent
        systemd: name=agent enabled=yes state=started daemon_reload=yes
- hosts: kafka
  vars:
    kafka_home: /opt/kafka
    kafka_replication_factor: 1
    kafka_partitions_number: 1
    kafka_version: 2.11-0.10.2.0
    kafka_port: 9092
    zookeeper_port: 2181
  remote_user: vagrant
  become: yes
  become_method: sudo
  tasks:
      - name: install kafka
        script: "/vagrant/bootstrap/kafka/install_kafka.sh {{kafka_version}} {{kafka_domain}} {{kafka_port}}"
        args:
            creates: /opt/kafka
      - name: copy init scripts to manage kafka and zookeeper servers
        copy: src={{ item.src }} dest={{ item.dest }} mode=751
        with_items:
            - { src: '/vagrant/bootstrap/kafka/kafka', dest: '/etc/init.d/kafka' }
            - { src: '/vagrant/bootstrap/kafka/zookeeper', dest: '/etc/init.d/zookeeper' }
      - name: start zookeeper
        systemd: name=zookeeper enabled=yes state=started daemon_reload=yes
      - name: start kafka
        systemd: name=kafka enabled=yes state=started daemon_reload=yes
      - name: create topic
        shell: "{{ kafka_home }}/bin/kafka-topics.sh --create --zookeeper {{ kafka_domain }}:{{ zookeeper_port }} --replication-factor {{ kafka_replication_factor }} --partitions {{ kafka_partitions_number }} --topic {{ kafka_topic }} &"  
- hosts: cassandra
  vars:
      cassandra_version: 30
      cassandra_port: 9042
  remote_user: vagrant
  become: yes
  become_method: sudo
  tasks:
      - name: copy datastax repo and cassandra scripts
        template: src={{ item.src }} dest={{ item.dest }} mode=751
        with_items:
            - { src: '/vagrant/bootstrap/cassandra/datastax.repo', dest: '/etc/yum.repos.d/datastax.repo' }
            - { src: '/vagrant/bootstrap/cassandra/create_keyspace_and_table.j2', dest: '/opt/create_keyspace_and_table.cql' }
      - name: install cassandra
        yum: name="dsc{{cassandra_version}}" state=present
      - name: configure cassandra
        script: "/vagrant/bootstrap/cassandra/configure_cassandra.sh {{ cassandra_domain }}"
      - name: start cassandra
        systemd: name=cassandra enabled=yes state=started daemon_reload=yes
      - name: wait for cassandra server
        local_action: wait_for host={{ cassandra_domain }} state=started port={{ cassandra_port }} delay=20 timeout=40 connect_timeout=10
      - name: create keyspace and table
        shell: "cqlsh {{cassandra_domain }} {{ cassandra_port }} -f /opt/create_keyspace_and_table.cql"
- hosts: spark
  vars:
    spark_version: spark-2.1.0-bin-hadoop2.7
    sbt_version: sbt-0.13.5
    sbt_rpm_repo: http://dl.bintray.com/sbt/rpm/
  remote_user: vagrant
  become: yes
  become_method: sudo
  tasks:
      - name: install sbt
        yum: name="{{sbt_rpm_repo}}{{sbt_version}}.rpm" state=present
      - name: install spark
        script: "/vagrant/bootstrap/spark/install_spark.sh {{spark_version}}"
        args:
            creates: /opt/spark
      - name: install spark consumer
        script: "/vagrant/bootstrap/spark/install_spark_consumer.sh {{ cassandra_domain }} {{ cassandra_keyspace }} {{ cassandra_table }} {{ kafka_domain }} {{ kafka_topic }}"
        args:
            creates: /opt/spark-structured-streaming-loader
      - name: copy init.d scripts to manage spark cluster and consumer
        copy: src={{ item.src }} dest={{ item.dest }} mode=751
        with_items:
            - { src: '/vagrant/bootstrap/spark/spark', dest: '/etc/init.d/spark' }
            - { src: '/vagrant/bootstrap/spark/consumer', dest: '/etc/init.d/consumer' }
      - name: source spark variables
        blockinfile:
          dest: "{{ ansible_env.HOME }}/.bashrc"
          block: |
            export SPARK_HOME=/opt/spark
            export SPARK_MASTER_IP={{spark_domain}}
            export SPARK_MASTER_PORT=7077
            export SPARK_MASTER_WEBUI_PORT=8080
            export SPARK_LOCAL_DIRS=$SPARK_HOME/work
            export SPARK_WORKER_CORES=1
            export SPARK_WORKER_MEMORY=1G
            export SPARK_WORKER_INSTANCES=2
            export SPARK_DAEMON_MEMORY=384m
          marker: '# {mark} ANSIBLE MANAGED BLOCK - virtualenv'
          insertbefore: BOF
          create: yes 
      - name: start spark
        systemd: name=spark enabled=yes state=started daemon_reload=yes
      - name: start spark consumer
        systemd: name=consumer enabled=yes state=started daemon_reload=yes